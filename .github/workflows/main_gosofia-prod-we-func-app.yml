name: Build and deploy dotnet core app to Azure Function App - gosofia-prod-we-func-app

on:
  push:
    branches: [main]
    paths:
      - "Events/Events.Crawler/**"
  workflow_dispatch:

env:
  DOTNET_VERSION: "8.0.x"
  AZURE_FUNCTIONAPP_NAME: "gosofia-prod-we-func-app"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: "Checkout GitHub Action"
        uses: actions/checkout@v4

      - name: Setup DotNet ${{ env.DOTNET_VERSION }} Environment
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js (for Playwright)
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install System Dependencies for Playwright
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3-dev libatk-bridge2.0-dev libdrm2 libxkbcommon0 libgtk-3-0

      - name: "Restore and Build Solution"
        shell: bash
        run: |
          if ls Events/*.sln 1> /dev/null 2>&1; then
            echo "Building from solution file..."
            dotnet restore Events/*.sln
            dotnet build Events/*.sln --configuration Release --no-restore
          else
            echo "Building individual projects..."
            dotnet restore Events/Events.Models/Events.Models.csproj
            dotnet restore Events/Events.Data/Events.Data.csproj
            dotnet restore Events/Events.Services/Events.Services.csproj
            dotnet restore Events/Events.Crawler/Events.Crawler.csproj

            dotnet build Events/Events.Models/Events.Models.csproj --configuration Release --no-restore
            dotnet build Events/Events.Data/Events.Data.csproj --configuration Release --no-restore
            dotnet build Events/Events.Services/Events.Services.csproj --configuration Release --no-restore
            dotnet build Events/Events.Crawler/Events.Crawler.csproj --configuration Release --no-restore
          fi

      - name: "Publish Function App"
        shell: bash
        run: |
          dotnet publish Events/Events.Crawler/Events.Crawler.csproj \
            --configuration Release \
            --output $GITHUB_WORKSPACE/output \
            --self-contained false

      - name: Clean old Playwright browsers
        shell: bash
        run: |
          rm -rf $GITHUB_WORKSPACE/output/playwright_browsers || true

      - name: Install Playwright Browsers (.NET)
        shell: bash
        run: |
          cd $GITHUB_WORKSPACE/output
          bash ./playwright.sh install || pwsh ./playwright.ps1 install

      - name: Log Playwright browsers after install
        shell: bash
        run: |
          echo "==> Contents of output/playwright_browsers after install:"
          find $GITHUB_WORKSPACE/output/playwright_browsers || echo "No browsers directory found"

      - name: Archive output folder
        run: |
          cd $GITHUB_WORKSPACE/output
          zip -r $GITHUB_WORKSPACE/output.zip .

      - name: Inspect zipped artifact (filtered)
        run: |
          echo "==> Inspecting zipped artifact (filtered)"
          unzip -l $GITHUB_WORKSPACE/output.zip | grep -E "playwright_browsers|chromium" || true

      - name: Show full zip contents
        run: |
          echo "==> Full zip listing:"
          unzip -l $GITHUB_WORKSPACE/output.zip

      - name: "Deploy to Azure Functions"
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          slot-name: "Production"
          package: "${{ github.workspace }}/output.zip"
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
