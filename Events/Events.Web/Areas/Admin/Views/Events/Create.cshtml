@model CreateEventViewModel

@{
    ViewData["Title"] = "Create Event";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-plus me-2"></i>Create New Event</h1>
    <a asp-action="Index" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to List
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <form asp-action="Create" method="post" id="createEventForm">
            @Html.AntiForgeryToken()
            
            <!-- Temporary Image Upload Session ID (GUID) -->
            <input type="hidden" id="TempImageSessionId" 
                   name="TempImageSessionId" value="@Guid.NewGuid()" />
            <input type="hidden" id="ThumbnailUrl" name="ThumbnailUrl" />

            <!-- Basic Information Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label asp-for="Name" class="form-label">Event Name *</label>
                            <input asp-for="Name" class="form-control" placeholder="Enter event name" required />
                            <span asp-validation-for="Name" class="text-danger small"></span>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Date" class="form-label">Date *</label>
                            <input asp-for="Date" type="date" class="form-control" required />
                            <span asp-validation-for="Date" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="StartTime" class="form-label">Start Time</label>
                            <input asp-for="StartTime" type="time" class="form-control" />
                            <span asp-validation-for="StartTime" class="text-danger small"></span>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="City" class="form-label">City *</label>
                            <input asp-for="City" class="form-control" placeholder="Sofia" required />
                            <span asp-validation-for="City" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="Location" class="form-label">Venue/Location *</label>
                            <input asp-for="Location" class="form-control" placeholder="Enter venue name" required />
                            <span asp-validation-for="Location" class="text-danger small"></span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="Description" class="form-label">Description</label>
                        <textarea asp-for="Description" class="form-control" rows="4" placeholder="Enter event description..."></textarea>
                        <span asp-validation-for="Description" class="text-danger small"></span>
                        <small class="text-muted">Current length: <span id="descLength">0</span> characters</small>
                    </div>
                </div>
            </div>
            
            <!-- Category & Classification Card -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Category & Classification</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="CategoryId" class="form-label">Category *</label>
                            <select asp-for="CategoryId" class="form-select" id="categorySelect" required>
                                <option value="">Select Category</option>
                                @foreach(var category in Model.AvailableCategories)
                                {
                                    <option value="@category.Id">
                                        @category.Name
                                    </option>
                                }
                            </select>
                            <span asp-validation-for="CategoryId" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="SubCategoryId" class="form-label">Subcategory *</label>
                            <select asp-for="SubCategoryId" class="form-select" id="subCategorySelect" required>
                                <option value="">Select Subcategory</option>
                                @foreach(var subCategory in Model.AvailableSubCategories)
                                {
                                    <option value="@subCategory.Id" 
                                            data-category-id="@subCategory.CategoryId">
                                        @subCategory.Name
                                    </option>
                                }
                            </select>
                            <span asp-validation-for="SubCategoryId" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Tags (up to 3)</label>
                            <div id="tagsContainer" class="d-flex flex-wrap gap-2 mb-2">
                                @foreach(var tag in Model.AvailableTags)
                                {
                                    var isSelected = Model.SelectedTagIds.Contains(tag.Id);
                                    <div class="form-check">
                                        <input class="form-check-input tag-checkbox" type="checkbox" 
                                               id="tag_@tag.Id" value="@tag.Id" 
                                               name="SelectedTagIds" 
                                               checked="@isSelected" />
                                        <label class="form-check-label" for="tag_@tag.Id">
                                            @tag.Name
                                        </label>
                                    </div>
                                }
                            </div>
                            <small class="text-muted">
                                Selected: <span id="selectedTagCount">@Model.SelectedTagIds.Count</span>/3
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Media & Links Card -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-image me-2"></i>Media & Links</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="url-tab" 
                                    data-bs-toggle="tab" 
                                    data-bs-target="#url-content" 
                                    type="button" role="tab">
                                <i class="fas fa-link me-2"></i>From URL
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="upload-tab" 
                                    data-bs-toggle="tab" 
                                    data-bs-target="#upload-content" 
                                    type="button" role="tab">
                                <i class="fas fa-cloud-upload-alt me-2"></i>Upload Image
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="url-content" 
                             role="tabpanel">
                            <div class="mb-3">
                                <label asp-for="ImageUrl" class="form-label">
                                    Image URL
                                </label>
                                <input asp-for="ImageUrl" class="form-control" 
                                       placeholder="https://example.com/image.jpg" />
                                <span asp-validation-for="ImageUrl" 
                                      class="text-danger small"></span>
                                <small class="text-muted">
                                    Or use the Upload tab to upload an image
                                </small>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="upload-content" 
                             role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Upload Image</label>
                                <div id="dropZone" 
                                     class="border-2 border-dashed rounded p-5 text-center cursor-pointer bg-light"
                                     style="border-color: #dee2e6; transition: all 0.3s;">
                                    <i class="fas fa-cloud-upload-alt" 
                                       style="font-size: 3rem; color: #6c757d;"></i>
                                    <p class="mt-3 mb-0">Drag and drop image here 
                                       or click to select</p>
                                    <small class="text-muted">
                                        Supported: JPEG, PNG, WebP (Max 5MB)
                                    </small>
                                    <input type="file" id="imageFile" 
                                           accept="image/jpeg,image/png,image/webp" 
                                           style="display: none;">
                                </div>
                                <div id="imagePreview" style="display: none;" 
                                     class="mt-3"></div>
                                <div id="uploadProgress" class="progress mt-2" 
                                     style="display: none;">
                                    <div class="progress-bar progress-bar-striped " +
                                         "progress-bar-animated" role="progressbar" 
                                         style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <img id="sidebarImagePreview" src="" alt="Event Image" 
                             class="img-thumbnail" 
                             style="max-height: 200px; display: none;">
                        <div id="noImagePreview" 
                             class="bg-light text-center p-5 rounded">
                            <i class="fas fa-image text-muted" 
                               style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">Image preview will appear here</p>
                        </div>
                    </div>
                    
                    <div class="mb-3 mt-3">
                        <label asp-for="TicketUrl" class="form-label">
                            Ticket URL
                        </label>
                        <input asp-for="TicketUrl" class="form-control" 
                               placeholder="https://tickets.example.com" />
                        <span asp-validation-for="TicketUrl" 
                              class="text-danger small"></span>
                    </div>
                </div>
            </div>
            
            <!-- Pricing Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Pricing</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input asp-for="IsFree" class="form-check-input" type="checkbox" id="isFreeSwitch" />
                            <label class="form-check-label" for="isFreeSwitch">
                                This is a free event
                            </label>
                        </div>
                    </div>
                    
                    @* <div class="mb-3" id="priceContainer">
                        <label asp-for="Price" class="form-label">Price (EUR)</label>
                        <input asp-for="Price" type="number" step="0.01" class="form-control" placeholder="0.00" />
                        <span asp-validation-for="Price" class="text-danger small"></span>
                    </div> *@
                </div>
            </div>
            
            <!-- Status & Options Card -->
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Status & Options</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Status" class="form-label">Event Status *</label>
                            <select asp-for="Status" class="form-select" required>
                                <option value="1" selected>Published</option>
                                <option value="0">Draft</option>
                                <option value="2">Cancelled</option>
                                <option value="3">Postponed</option>
                                <option value="4">Sold Out</option>
                            </select>
                            <span asp-validation-for="Status" class="text-danger small"></span>
                        </div>
                        
                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <div class="form-check form-switch">
                                <input asp-for="IsFeatured" class="form-check-input" type="checkbox" id="isFeaturedSwitch" />
                                <label class="form-check-label" for="isFeaturedSwitch">
                                    <i class="fas fa-star text-warning me-1"></i>
                                    <strong>Featured Event</strong>
                                </label>
                                <small class="d-block text-muted">Display on homepage</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-flex gap-2 mb-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-plus me-2"></i>Create Event
                </button>
                <a asp-action="Index" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times me-2"></i>Cancel
                </a>
            </div>
        </form>
    </div>
    
    <!-- Sidebar with Live Preview -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Event Preview</h5>
            </div>
            <div class="card-body">
                <div id="imagePreviewContainer">
                    <div id="noImagePreview" class="bg-light text-center p-5 rounded mb-3">
                        <i class="fas fa-image text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">No image yet</p>
                    </div>
                    <img id="sidebarImagePreview" src="" alt="Event Image" class="img-fluid rounded mb-3" style="display: none;">
                </div>
                
                <h5 class="card-title" id="previewTitle">Event Name</h5>
                
                <div class="mb-2">
                    <small class="text-muted" id="previewDate">
                        <i class="fas fa-calendar me-1"></i>
                        No date selected
                    </small>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted" id="previewLocation">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        No location
                    </small>
                </div>
                
                <div class="mb-3" id="previewBadges">
                    <span class="badge bg-secondary">Draft</span>
                </div>
                
                <p class="small text-muted" id="previewDescription">
                    Event description will appear here
                </p>
                
                <hr/>
                
                <div class="alert alert-info small mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Preview updates as you fill in the form
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/admin-image-upload.js"></script>
    
    <script>
        $(document).ready(function() {
            // Initialize image uploader with temporary GUID
            const tempSessionId = document.getElementById('TempImageSessionId').value;
            
            // Subcategory filtering based on category selection
            var allSubCategories = [];
            $('#subCategorySelect option').each(function() {
                if ($(this).val()) {
                    allSubCategories.push({
                        value: $(this).val(),
                        text: $(this).text(),
                        categoryId: $(this).data('category-id')
                    });
                }
            });
            
            function filterSubCategories() {
                var selectedCategoryId = parseInt($('#categorySelect').val());
                
                $('#subCategorySelect').empty();
                $('#subCategorySelect').append('<option value="">Select Subcategory</option>');
                
                if (selectedCategoryId) {
                    var filtered = allSubCategories.filter(function(sc) {
                        return sc.categoryId === selectedCategoryId;
                    });
                    
                    filtered.forEach(function(sc) {
                        var option = $('<option></option>')
                            .val(sc.value)
                            .text(sc.text)
                            .data('category-id', sc.categoryId);
                        
                        $('#subCategorySelect').append(option);
                    });
                }
            }
            
            // Filter on category change
            $('#categorySelect').change(function() {
                filterSubCategories();
                updatePreview();
            });

            // Tag selection - maximum 3
            const MAX_TAGS = 3;
            $('.tag-checkbox').on('change', function() {
                const checkedCount = $('.tag-checkbox:checked').length;
                
                if (checkedCount > MAX_TAGS) {
                    $(this).prop('checked', false);
                    alert('You can select a maximum of ' + MAX_TAGS + ' tags');
                    return;
                }
                
                $('#selectedTagCount').text(checkedCount);
                updatePreview();
            });
            
            // Free event toggle - disable/enable price field
            function togglePriceField() {
                if ($('#isFreeSwitch').is(':checked')) {
                    $('#priceContainer').hide();
                    $('input[name="Price"]').val('');
                } else {
                    $('#priceContainer').show();
                }
                updatePreview();
            }
            
            $('#isFreeSwitch').change(togglePriceField);
            togglePriceField(); // Initial state
            
            // Description character counter
            $('textarea[name="Description"]').on('input', function() {
                $('#descLength').text($(this).val().length);
                updatePreview();
            });
            
            // Image URL preview
            $('input[name="ImageUrl"]').on('blur', function() {
                var url = $(this).val();
                if (url) {
                    $('#sidebarImagePreview').attr('src', url).show();
                    $('#imagePreviewContainer #noImagePreview').hide();
                } else {
                    $('#sidebarImagePreview').hide();
                    $('#imagePreviewContainer #noImagePreview').show();
                }
            }).on('input', function() {
                updatePreview();
            });
            
            // Form inputs for preview
            $('input[name="Name"], input[name="Date"], input[name="StartTime"], input[name="City"], input[name="Location"], input[name="Price"], input[name="IsFeatured"], select[name="Status"]').on('change input', function() {
                updatePreview();
            });
            
            // Update preview function
            function updatePreview() {
                var name = $('input[name="Name"]').val() || 'Event Name';
                var date = $('input[name="Date"]').val() || '';
                var startTime = $('input[name="StartTime"]').val() || '';
                var city = $('input[name="City"]').val() || '';
                var location = $('input[name="Location"]').val() || '';
                var description = $('textarea[name="Description"]').val() || 'Event description will appear here';
                var isFree = $('#isFreeSwitch').is(':checked');
                var price = $('input[name="Price"]').val() || '';
                var isFeatured = $('#isFeaturedSwitch').is(':checked');
                var status = $('select[name="Status"]').val() || '1';
                
                // Update title
                $('#previewTitle').text(name);
                
                // Update date
                if (date) {
                    var dateObj = new Date(date + 'T00:00:00');
                    var dateStr = dateObj.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });
                    var timeStr = startTime ? ' at ' + startTime : '';
                    $('#previewDate').html('<i class="fas fa-calendar me-1"></i>' + dateStr + timeStr);
                } else {
                    $('#previewDate').html('<i class="fas fa-calendar me-1"></i>No date selected');
                }
                
                // Update location
                if (city && location) {
                    $('#previewLocation').html('<i class="fas fa-map-marker-alt me-1"></i>' + location + ', ' + city);
                } else {
                    $('#previewLocation').html('<i class="fas fa-map-marker-alt me-1"></i>No location');
                }
                
                // Update description
                $('#previewDescription').text(description);
                
                // Update badges
                var badges = '';
                if (isFree) {
                    badges += '<span class="badge bg-success">Free Event</span> ';
                } else if (price) {
                    badges += '<span class="badge bg-primary">' + price + ' EUR</span> ';
                }
                
                if (isFeatured) {
                    badges += '<span class="badge bg-warning text-dark"><i class="fas fa-star me-1"></i>Featured</span> ';
                }
                
                // Status badge
                var statusText = $('select[name="Status"] option:selected').text();
                var statusClass = status == '1' ? 'bg-success' : (status == '0' ? 'bg-secondary' : 'bg-warning');
                badges += '<span class="badge ' + statusClass + '">' + statusText + '</span>';
                
                $('#previewBadges').html(badges);
            }
            
            // Initial preview update
            updatePreview();
            
            // Form validation feedback
            $('#createEventForm').on('submit', function(e) {
                if (!this.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                $(this).addClass('was-validated');
            });
            
            // Tags selection logic
            var maxTags = 3;
            $('.tag-checkbox').change(function() {
                var checkedTags = $('.tag-checkbox:checked').length;
                
                if (checkedTags > maxTags) {
                    $(this).prop('checked', false);
                    alert('You can select up to ' + maxTags + ' tags only.');
                }
                
                $('#selectedTagCount').text($('.tag-checkbox:checked').length);
                updatePreview();
            });
        });
    </script>
}

@section Styles {
    <style>
        #dropZone {
            cursor: pointer;
            user-select: none;
        }

        #dropZone.drag-over {
            background-color: #e7f3ff !important;
            border-color: #0d6efd !important;
            transform: scale(1.02);
        }

        .preview-wrapper {
            position: relative;
        }

        .preview-image {
            max-width: 100%;
            border-radius: 0.25rem;
        }

        .preview-info {
            display: block;
            margin-top: 0.5rem;
            color: #6c757d;
        }
    </style>
}
