@model EditEventViewModel

@{
    ViewData["Title"] = "Edit Event";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-edit me-2"></i>Edit Event</h1>
    <a asp-action="Index" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to List
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <form asp-action="Edit" method="post" id="editEventForm">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            
            <!-- Basic Information Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label asp-for="Name" class="form-label">Event Name *</label>
                            <input asp-for="Name" class="form-control" placeholder="Enter event name" required />
                            <span asp-validation-for="Name" class="text-danger small"></span>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Date" class="form-label">Date *</label>
                            <input asp-for="Date" type="date" class="form-control" required />
                            <span asp-validation-for="Date" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="StartTime" class="form-label">Start Time</label>
                            <input asp-for="StartTime" type="time" class="form-control" />
                            <span asp-validation-for="StartTime" class="text-danger small"></span>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="City" class="form-label">City *</label>
                            <input asp-for="City" class="form-control" placeholder="Sofia" required />
                            <span asp-validation-for="City" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="Location" class="form-label">Venue/Location *</label>
                            <input asp-for="Location" class="form-control" placeholder="Enter venue name" required />
                            <span asp-validation-for="Location" class="text-danger small"></span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="Description" class="form-label">Description</label>
                        <textarea asp-for="Description" class="form-control" rows="4" placeholder="Enter event description..."></textarea>
                        <span asp-validation-for="Description" class="text-danger small"></span>
                        <small class="text-muted">Current length: <span id="descLength">@(Model.Description?.Length ?? 0)</span> characters</small>
                    </div>
                </div>
            </div>
            
            <!-- Category & Classification Card -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Category & Classification</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="CategoryId" class="form-label">Category *</label>
                            <select asp-for="CategoryId" class="form-select" id="categorySelect" required>
                                <option value="">Select Category</option>
                                @foreach(var category in Model.AvailableCategories)
                                {
                                    <option value="@category.Id" selected="@(category.Id == Model.CategoryId)">
                                        @category.Name
                                    </option>
                                }
                            </select>
                            <span asp-validation-for="CategoryId" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="SubCategoryId" class="form-label">Subcategory</label>
                            <select asp-for="SubCategoryId" class="form-select" id="subCategorySelect">
                                <option value="">None (Optional)</option>
                                @foreach(var subCategory in Model.AvailableSubCategories)
                                {
                                    <option value="@subCategory.Id" 
                                            data-category-id="@subCategory.CategoryId"
                                            selected="@(subCategory.Id == Model.SubCategoryId)">
                                        @subCategory.Name
                                    </option>
                                }
                            </select>
                            <span asp-validation-for="SubCategoryId" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Tags (up to 3)</label>
                            <div id="tagsContainer" class="d-flex flex-wrap gap-2 mb-2">
                                @foreach(var tag in Model.AvailableTags)
                                {
                                    var isSelected = Model.SelectedTagIds.Contains(tag.Id);
                                    <div class="form-check">
                                        <input class="form-check-input tag-checkbox" type="checkbox" 
                                               id="tag_@tag.Id" value="@tag.Id" 
                                               name="SelectedTagIds" 
                                               checked="@isSelected" />
                                        <label class="form-check-label" for="tag_@tag.Id">
                                            @tag.Name
                                        </label>
                                    </div>
                                }
                            </div>
                            <small class="text-muted">
                                Selected: <span id="selectedTagCount">@Model.SelectedTagIds.Count</span>/3
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Media & Links Card -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-image me-2"></i>Media & Links</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="url-tab" 
                                    data-bs-toggle="tab" 
                                    data-bs-target="#url-content" 
                                    type="button" role="tab">
                                <i class="fas fa-link me-2"></i>From URL
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="upload-tab" 
                                    data-bs-toggle="tab" 
                                    data-bs-target="#upload-content" 
                                    type="button" role="tab">
                                <i class="fas fa-cloud-upload-alt me-2"></i>Upload Image
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="url-content" 
                             role="tabpanel">
                            <div class="mb-3">
                                <label asp-for="ImageUrl" class="form-label">
                                    Image URL
                                </label>
                                <input asp-for="ImageUrl" class="form-control" 
                                       placeholder="https://example.com/image.jpg" />
                                <span asp-validation-for="ImageUrl" 
                                      class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="upload-content" 
                             role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Upload Image</label>
                                <div id="dropZone" 
                                     class="border-2 border-dashed rounded p-5 text-center cursor-pointer bg-light"
                                     style="border-color: #dee2e6; transition: all 0.3s;">
                                    <i class="fas fa-cloud-upload-alt" 
                                       style="font-size: 3rem; color: #6c757d;"></i>
                                    <p class="mt-3 mb-0">Drag and drop image here 
                                       or click to select</p>
                                    <small class="text-muted">
                                        Supported: JPEG, PNG, WebP (Max 5MB)
                                    </small>
                                    <input type="file" id="imageFile" 
                                           accept="image/jpeg,image/png,image/webp" 
                                           style="display: none;">
                                </div>
                                <div id="imagePreview" style="display: none;" 
                                     class="mt-3"></div>
                                <div id="uploadProgress" class="progress mt-2" 
                                     style="display: none;">
                                    <div class="progress-bar progress-bar-striped " +
                                         "progress-bar-animated" role="progressbar" 
                                         style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        @if(!string.IsNullOrEmpty(Model.ImageUrl))
                        {
                            <img src="@Model.ImageUrl" alt="Event Image" class="img-thumbnail" style="max-height: 200px;">
                        }
                        else
                        {
                            <div class="bg-light text-center p-5 rounded">
                                <i class="fas fa-image text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-2">No image</p>
                            </div>
                        }
                    </div>
                    
                    <div class="mb-3 mt-3">
                        <label asp-for="TicketUrl" class="form-label">
                            Ticket URL
                        </label>
                        <input asp-for="TicketUrl" class="form-control" 
                               placeholder="https://tickets.example.com" />
                        <span asp-validation-for="TicketUrl" 
                              class="text-danger small"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="SourceUrl" class="form-label">
                            Source URL
                        </label>
                        <input asp-for="SourceUrl" class="form-control" 
                               placeholder="https://source.example.com" readonly />
                        <small class="text-muted">
                            Original source where event was crawled from (read-only)
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Pricing Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Pricing</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input asp-for="IsFree" class="form-check-input" type="checkbox" id="isFreeSwitch" />
                            <label class="form-check-label" for="isFreeSwitch">
                                This is a free event
                            </label>
                        </div>
                    </div>
                    
                    @* <div class="mb-3" id="priceContainer">
                        <label asp-for="Price" class="form-label">Price (EUR)</label>
                        <input asp-for="Price" type="number" step="0.01" class="form-control" placeholder="0.00" />
                        <span asp-validation-for="Price" class="text-danger small"></span>
                    </div> *@
                </div>
            </div>
            
            <!-- Status & Options Card -->
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Status & Options</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Status" class="form-label">Event Status *</label>
                            <select asp-for="Status" class="form-select" required>
                                <option value="0" selected="@(Model.Status == EventStatus.Draft)">Draft</option>
                                <option value="1" selected="@(Model.Status == EventStatus.Published)">Published</option>
                                <option value="2" selected="@(Model.Status == EventStatus.Cancelled)">Cancelled</option>
                                <option value="3" selected="@(Model.Status == EventStatus.Postponed)">Postponed</option>
                                <option value="4" selected="@(Model.Status == EventStatus.SoldOut)">Sold Out</option>
                            </select>
                            <span asp-validation-for="Status" class="text-danger small"></span>
                        </div>
                        
                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <div class="form-check form-switch">
                                <input asp-for="IsFeatured" class="form-check-input" type="checkbox" id="isFeaturedSwitch" />
                                <label class="form-check-label" for="isFeaturedSwitch">
                                    <i class="fas fa-star text-warning me-1"></i>
                                    <strong>Featured Event</strong>
                                </label>
                                <small class="d-block text-muted">Display on homepage</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-flex gap-2 mb-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
                <a asp-action="Index" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times me-2"></i>Cancel
                </a>
                <button type="button" class="btn btn-danger btn-lg ms-auto" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="fas fa-trash me-2"></i>Delete Event
                </button>
            </div>
        </form>
    </div>
    
    <!-- Sidebar with Preview -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Event Preview</h5>
            </div>
            <div class="card-body">
                @if(!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <img src="@Model.ImageUrl" alt="@Model.Name" class="img-fluid rounded mb-3">
                }
                else
                {
                    <div class="bg-light text-center p-5 rounded mb-3">
                        <i class="fas fa-image text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">No image</p>
                    </div>
                }
                
                <h5 class="card-title">@Model.Name</h5>
                
                <div class="mb-2">
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>
                        @Model.Date.ToString("dd.MM.yyyy")
                        @if(Model.StartTime.HasValue)
                        {
                            <text> at @Model.StartTime.Value.ToString(@"hh\:mm")</text>
                        }
                    </small>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        @Model.Location, @Model.City
                    </small>
                </div>
                
                <div class="mb-3">
                    @if(Model.IsFree)
                    {
                        <span class="badge bg-success">Free Event</span>
                    }
                    else if(Model.Price.HasValue)
                    {
                        <span class="badge bg-primary">@Model.Price.Value.ToString("F2") EUR</span>
                    }
                    
                    @if(Model.IsFeatured)
                    {
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-star me-1"></i>Featured
                        </span>
                    }
                    
                    @switch(Model.Status)
                    {
                        case EventStatus.Published:
                            <span class="badge bg-success">Published</span>
                            break;
                        case EventStatus.Draft:
                            <span class="badge bg-secondary">Draft</span>
                            break;
                        case EventStatus.Cancelled:
                            <span class="badge bg-danger">Cancelled</span>
                            break;
                        case EventStatus.Postponed:
                            <span class="badge bg-warning">Postponed</span>
                            break;
                        case EventStatus.SoldOut:
                            <span class="badge bg-info">Sold Out</span>
                            break;
                    }
                </div>
                
                @if(!string.IsNullOrEmpty(Model.Description))
                {
                    <p class="small text-muted">@Model.Description</p>
                }
                
                <hr/>
                
                <div class="d-grid gap-2">
                    <a asp-area="" asp-controller="Events" asp-action="Details" asp-route-id="@Model.Id" 
                       class="btn btn-outline-primary btn-sm" target="_blank">
                        <i class="fas fa-external-link-alt me-1"></i>View on Website
                    </a>
                    @if(!string.IsNullOrEmpty(Model.SourceUrl))
                    {
                        <a href="@Model.SourceUrl" class="btn btn-outline-secondary btn-sm" target="_blank">
                            <i class="fas fa-link me-1"></i>View Source
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this event?</p>
                <p class="fw-bold">@Model.Name</p>
                <p class="text-danger">This action cannot be undone!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form asp-action="Delete" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Delete Event
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/admin-image-upload.js"></script>
    
    <script>
        $(document).ready(function() {
            // Subcategory filtering based on category selection
            var allSubCategories = [];
            $('#subCategorySelect option').each(function() {
                if ($(this).val()) {
                    allSubCategories.push({
                        value: $(this).val(),
                        text: $(this).text(),
                        categoryId: $(this).data('category-id')
                    });
                }
            });
            
            function filterSubCategories() {
                var selectedCategoryId = parseInt($('#categorySelect').val());
                var currentSubCategoryId = parseInt($('#subCategorySelect').val());
                
                $('#subCategorySelect').empty();
                $('#subCategorySelect').append('<option value="">None (Optional)</option>');
                
                if (selectedCategoryId) {
                    var filtered = allSubCategories.filter(function(sc) {
                        return sc.categoryId === selectedCategoryId;
                    });
                    
                    filtered.forEach(function(sc) {
                        var option = $('<option></option>')
                            .val(sc.value)
                            .text(sc.text)
                            .data('category-id', sc.categoryId);
                        
                        if (parseInt(sc.value) === currentSubCategoryId) {
                            option.prop('selected', true);
                        }
                        
                        $('#subCategorySelect').append(option);
                    });
                }
            }
            
            // Filter on category change
            $('#categorySelect').change(function() {
                filterSubCategories();
            });
            
            // Initial filter on page load
            filterSubCategories();

            // Tag selection - maximum 3
            const MAX_TAGS = 3;
            $('.tag-checkbox').on('change', function() {
                const checkedCount = $('.tag-checkbox:checked').length;
                
                if (checkedCount > MAX_TAGS) {
                    $(this).prop('checked', false);
                    alert('You can select a maximum of ' + MAX_TAGS + ' tags');
                    return;
                }
                
                $('#selectedTagCount').text(checkedCount);
            });
            
            // Free event toggle - disable/enable price field
            function togglePriceField() {
                if ($('#isFreeSwitch').is(':checked')) {
                    $('#priceContainer').hide();
                    $('input[name="Price"]').val('');
                } else {
                    $('#priceContainer').show();
                }
            }
            
            $('#isFreeSwitch').change(togglePriceField);
            togglePriceField(); // Initial state
            
            // Description character counter
            $('textarea[name="Description"]').on('input', function() {
                $('#descLength').text($(this).val().length);
            });
            
            // Image URL preview
            $('input[name="ImageUrl"]').on('blur', function() {
                var url = $(this).val();
                if (url) {
                    // Update preview (we can also validate URL first)
                    // console.log('Image URL changed:', url);
                }
            });
            
            // Tags limit logic
            function updateTagSelection() {
                var selectedTags = $('input[name="SelectedTagIds"]:checked');
                var count = selectedTags.length;
                
                $('#selectedTagCount').text(count);
                
                // Disable other checkboxes if limit reached
                if (count >= 3) {
                    $('input[name="SelectedTagIds"]').not(':checked').prop('disabled', true);
                } else {
                    $('input[name="SelectedTagIds"]').prop('disabled', false);
                }
            }
            
            // Initial tag selection update
            updateTagSelection();
            
            // Update on tag change
            $('input[name="SelectedTagIds"]').change(updateTagSelection);
            
            // Form validation feedback
            $('#editEventForm').on('submit', function(e) {
                if (!this.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                $(this).addClass('was-validated');
            });
        });
    </script>
}

@section Styles {
    <style>
        #dropZone {
            cursor: pointer;
            user-select: none;
        }

        #dropZone.drag-over {
            background-color: #e7f3ff !important;
            border-color: #0d6efd !important;
            transform: scale(1.02);
        }

        .preview-wrapper {
            position: relative;
        }

        .preview-image {
            max-width: 100%;
            border-radius: 0.25rem;
        }

        .preview-info {
            display: block;
            margin-top: 0.5rem;
            color: #6c757d;
        }
    </style>
}
