@model Events.Web.Models.EventsPageViewModel

@{
    ViewData["Title"] = Model.PageTitle;
}

<!-- Enhanced Filters Section -->
<section class="filters-section bg-light py-4">
    <div class="container">
        <form method="get" class="row g-3" id="search-form">
            <!-- Search with autocomplete -->
            <div class="col-md-3">
                <label for="search" class="form-label">Search Events</label>
                <div class="position-relative">
                    <input type="text" class="form-control" id="search" name="search" 
                           value="@Model.SearchTerm" placeholder="Search by name, location...">
                    <i class="fas fa-search position-absolute top-50 end-0 translate-middle-y pe-3 text-muted"></i>
                </div>
            </div>
            
            <!-- Category -->
            <div class="col-md-2">
                <label for="category" class="form-label">Category</label>
                <select class="form-select" id="category" name="category">
                    <option value="">All Categories</option>
                    @foreach(var cat in EventsPageViewModel.AvailableCategories)
                    {
                        <option value="@cat.Value" selected="@(Model.CurrentCategory == cat.Value)">
                            @cat.DisplayName
                        </option>
                    }
                </select>
            </div>
            
            <!-- Price Filter -->
            <div class="col-md-2">
                <label for="free" class="form-label">Price</label>
                <select class="form-select" id="free" name="free">
                    <option value="">All Events</option>
                    <option value="true" selected="@(Model.IsFreeFilter == true)">Free Only</option>
                    <option value="false" selected="@(Model.IsFreeFilter == false)">Paid Only</option>
                </select>
            </div>
            
            <!-- Date From -->
            <div class="col-md-2">
                <label for="fromDate" class="form-label">From Date</label>
                <input type="date" class="form-control" id="fromDate" name="fromDate" 
                       value="@Model.FromDate?.ToString("yyyy-MM-dd")">
            </div>
            
            <!-- Date To -->
            <div class="col-md-2">
                <label for="toDate" class="form-label">To Date</label>
                <input type="date" class="form-control" id="toDate" name="toDate" 
                       value="@Model.ToDate?.ToString("yyyy-MM-dd")">
            </div>
            
            <!-- Actions -->
            <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </form>
        
        <!-- Active Filters Display -->
        @if(Model.HasActiveFilters)
        {
            <div class="mt-3">
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted">Active filters:</span>
                    @if(!string.IsNullOrEmpty(Model.CurrentCategory))
                    {
                        <span class="badge bg-primary">Category: @Model.CurrentCategory</span>
                    }
                    @if(Model.IsFreeFilter == true)
                    {
                        <span class="badge bg-success">Free Events</span>
                    }
                    @if(Model.IsFreeFilter == false)
                    {
                        <span class="badge bg-warning">Paid Events</span>
                    }
                    @if(!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        <span class="badge bg-info">Search: "@Model.SearchTerm"</span>
                    }
                    <a href="/Events" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-times"></i> Clear All
                    </a>
                </div>
            </div>
        }
    </div>
</section>

<!-- Sorting and View Options -->
<div class="bg-white py-3 border-bottom">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted">Sort by:</span>
                    <div class="btn-group" role="group">
                        @foreach(var sortOption in EventsPageViewModel.AvailableSortOptions)
                        {
                            var isCurrentSort = Model.SortBy == sortOption.Value;
                            var newSortOrder = isCurrentSort && Model.SortOrder == "asc" ? "desc" : "asc";
                            
                            <a href="@Url.Action("Index", "Events", new {
                                    category = Model.CurrentCategory,
                                    free = Model.IsFreeFilter,
                                    search = Model.SearchTerm,
                                    fromDate = Model.FromDate?.ToString("yyyy-MM-dd"),
                                    toDate = Model.ToDate?.ToString("yyyy-MM-dd"),
                                    sortBy = sortOption.Value,
                                    sortOrder = newSortOrder,
                                    page = 1
                            })" 
                               class="btn btn-sm @(isCurrentSort ? "btn-primary" : "btn-outline-secondary")">
                                <i class="@sortOption.IconClass me-1"></i>@sortOption.DisplayName
                                @if(isCurrentSort)
                                {
                                    <i class="fas fa-chevron-@(Model.SortOrder == "asc" ? "up" : "down") ms-1"></i>
                                }
                            </a>
                        }
                    </div>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="d-flex align-items-center justify-content-end gap-2">
                    <span class="text-muted">View:</span>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active" id="grid-view">
                            <i class="fas fa-th"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="list-view">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Section -->
<section class="py-4">
    <div class="container">
        <!-- Results Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>@Model.PageTitle</h2>
                @if(Model.HasActiveFilters)
                {
                    <p class="text-muted mb-0">
                        Filtered results 
                        @if(!string.IsNullOrEmpty(Model.CurrentCategory))
                        {
                            <span class="badge bg-primary">@Model.CurrentCategory</span>
                        }
                        @if(Model.IsFreeFilter == true)
                        {
                            <span class="badge bg-success">Free Events</span>
                        }
                    </p>
                }
            </div>
            <small class="text-muted">
                Showing @((Model.Events.CurrentPage - 1) * Model.Events.PageSize + 1) - 
                @Math.Min(Model.Events.CurrentPage * Model.Events.PageSize, Model.Events.TotalCount) 
                of @Model.Events.TotalCount events
            </small>
        </div>
        
        <!-- Events Grid -->
        <div class="row">
            @if(Model.Events.Items.Any())
            {
                @foreach(var eventItem in Model.Events.Items)
                {
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card event-card h-100">
                            <a href="@Url.Action("Details", "Events", new { id = eventItem.Id })" class="text-decoration-none">
                                <div class="event-image-container">
                                    <img src="@eventItem.DefaultImage" 
                                         alt="@eventItem.Name" 
                                         class="event-image-full"
                                         onerror="this.src='/images/default-event.jpg'">
                                    <div class="event-price @(eventItem.IsFree ? "event-free" : "")">
                                        @eventItem.PriceDisplay
                                    </div>
                                </div>
                            </a>
                            
                            <div class="card-body d-flex flex-column">
                                <h5 class="event-title">
                                    <a href="@Url.Action("Details", "Events", new { id = eventItem.Id })" class="text-decoration-none text-dark">
                                        @eventItem.Name
                                    </a>
                                </h5>
                                <div class="event-date mb-2">
                                    <i class="fas fa-calendar me-1"></i>
                                    @eventItem.FormattedDate @eventItem.FormattedTime
                                </div>
                                <div class="event-venue mb-2">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    @eventItem.Location
                                </div>
                                
                                @if(!string.IsNullOrEmpty(eventItem.CategoryName))
                                {
                                    <div class="mb-2">
                                        <a href="@Url.Action("Category", "Events", new { category = eventItem.CategoryName })" class="badge bg-secondary text-decoration-none">
                                            @eventItem.CategoryName
                                        </a>
                                        @if(!string.IsNullOrEmpty(eventItem.SubCategoryName))
                                        {
                                            <span class="badge bg-light text-dark ms-1">@eventItem.SubCategoryName</span>
                                        }
                                    </div>
                                }
                                
                                @if(eventItem.Tags.Any())
                                {
                                    <div class="event-tags mb-2">
                                        @foreach(var tag in eventItem.Tags.Take(3))
                                        {
                                            <span class="badge bg-info text-dark me-1">@tag</span>
                                        }
                                    </div>
                                }
                                
                                @if(!string.IsNullOrEmpty(eventItem.ShortDescription))
                                {
                                    <p class="text-muted small flex-grow-1">@eventItem.ShortDescription</p>
                                }
                            </div>
                            
                            <div class="card-footer bg-transparent">
                                <div class="d-flex justify-content-between">
                                    <a href="@Url.Action("Details", "Events", new { id = eventItem.Id })" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-info-circle me-1"></i>Details
                                    </a>
                                    @if(eventItem.HasTicketUrl)
                                    {
                                        <a href="@eventItem.TicketUrl" target="_blank" class="btn btn-primary btn-sm">
                                            <i class="fas fa-ticket-alt me-1"></i>Buy tickets
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12 text-center py-5">
                    <i class="fas fa-calendar-times text-muted" style="font-size: 4rem;"></i>
                    <h4 class="mt-3 text-muted">No events found</h4>
                    <p class="text-muted">Try adjusting your search criteria or browse all events.</p>
                    <a href="/Events" class="btn btn-primary">View All Events</a>
                </div>
            }
        </div>
        
        <!-- Pagination -->
        @if(Model.Events.TotalPages > 1)
        {
            <nav aria-label="Events pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    @if(Model.Events.HasPreviousPage)
                    {
                        <li class="page-item">
                            <a class="page-link" href="?page=@(Model.Events.CurrentPage - 1)&@Model.FiltersQueryString">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        </li>
                    }
                    
                    @for(var i = Math.Max(1, Model.Events.CurrentPage - 2); i <= Math.Min(Model.Events.TotalPages, Model.Events.CurrentPage + 2); i++)
                    {
                        <li class="page-item @(i == Model.Events.CurrentPage ? "active" : "")">
                            <a class="page-link" href="?page=@i&@Model.FiltersQueryString">@i</a>
                        </li>
                    }
                    
                    @if(Model.Events.HasNextPage)
                    {
                        <li class="page-item">
                            <a class="page-link" href="?page=@(Model.Events.CurrentPage + 1)&@Model.FiltersQueryString">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        }
    </div>
</section>

@section Scripts {
    <!-- jQuery UI for autocomplete -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/ui-lightness/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    
    <!-- search script -->
    <script src="~/js/search.js" asp-append-version="true"></script>
    
    <script>
        // Initialize search functionality when document is ready
        $(document).ready(function() {
            $('#search').autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: '/Events/Search',
                        data: { query: request.term },
                        success: function(data) {
                            response($.map(data, function(item) {
                                return {
                                    label: item.name + (item.category ? ' (' + item.category + ')' : ''),
                                    value: item.name,
                                    id: item.id,
                                    category: item.category
                                };
                            }));
                        }
                    });
                },
                minLength: 2,
                select: function(event, ui) {
                    window.location.href = '/Events/Details/' + ui.item.id;
                    return false;
                },
                focus: function(event, ui) {
                    $('#search').val(ui.item.value);
                    return false;
                }
            }).autocomplete("instance")._renderItem = function(ul, item) {
                return $("<li>")
                    .append("<div class='autocomplete-item'><strong>" + item.value + "</strong>" + 
                           (item.category ? "<br><small class='text-muted'>" + item.category + "</small>" : "") + "</div>")
                    .appendTo(ul);
            };
        });
    </script>
}