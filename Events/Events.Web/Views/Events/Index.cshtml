@model Events.Web.Models.EventsPageViewModel

@{
    ViewData["Title"] = Model.PageTitle;
}

<!-- Enhanced Filters Section -->
<section class="filters-section bg-light py-4">
    <div class="container">
        <form method="get" class="row g-3" id="search-form">
            <!-- Category -->
            <div class="col-md-2">
                <label for="category" class="form-label">Category</label>
                <select class="form-select" id="category" name="category">
                    <option value="">All Categories</option>
                    @foreach(var cat in EventsPageViewModel.AvailableCategories)
                    {
                        <option value="@cat.Value" selected="@(Model.CurrentCategory == cat.Value)">
                            @cat.DisplayName
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label for="subCategory" class="form-label">Subcategory</label>
                <select class="form-select" id="subCategory" name="subCategory">
                    @if(Model.AvailableSubCategories.Any())
                    {
                        <option value="" selected="@(string.IsNullOrEmpty(Model.SelectedSubCategory))">
                            All Subcategories
                        </option>
                        @foreach(var option in Model.AvailableSubCategories)
                        {
                            <option value="@option.Value" selected="@(option.Selected)">
                                @option.Text
                            </option>
                        }
                    }
                    else
                    {
                        <option value="" selected>Select a category first</option>
                    }
                </select>
            </div>

            <!-- Price Filter -->
            <div class="col-md-2">
                <label for="free" class="form-label">Price</label>
                <select class="form-select" id="free" name="free">
                    <option value="">All Events</option>
                    <option value="true" selected="@(Model.IsFreeFilter == true)">Free Only</option>
                    <option value="false" selected="@(Model.IsFreeFilter == false)">Paid Only</option>
                </select>
            </div>

            <!-- Date From -->
            <div class="col-md-2">
                <label for="fromDate" class="form-label">From Date</label>
                <input type="date" class="form-control" id="fromDate" name="fromDate" 
                       value="@Model.FromDate?.ToString("yyyy-MM-dd")">
            </div>

            <!-- Date To -->
            <div class="col-md-2">
                <label for="toDate" class="form-label">To Date</label>
                <input type="date" class="form-control" id="toDate" name="toDate" 
                       value="@Model.ToDate?.ToString("yyyy-MM-dd")">
            </div>

            <!-- Actions -->
            <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <!-- Hidden field for selected tags -->
            <input type="hidden" id="tags" name="tags" value="@string.Join(",", Model.SelectedTags)">
        </form>
        
        <!-- Tag Cloud Section -->
        @if(Model.PopularTags.Any())
        {
            <div class="mt-4">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6 class="mb-0">Popular Tags</h6>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#tagCloud">
                        <i class="fas fa-tags"></i> Browse Tags
                    </button>
                </div>
                
                <div class="collapse @(Model.SelectedTags.Any() ? "show" : "")" id="tagCloud">
                    <div class="bg-white p-3 rounded border">
                        <!-- Selected Tags -->
                        @if(Model.SelectedTags.Any())
                        {
                            <div class="mb-3">
                                <small class="text-muted">Selected tags:</small>
                                <div class="mt-1">
                                    @foreach(var selectedTag in Model.SelectedTags)
                                    {
                                        <span class="badge bg-primary me-1 mb-1" style="font-size: 0.9rem;">
                                            <i class="fas fa-tag me-1"></i>@selectedTag
                                            <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.6rem;" onclick="removeTag('@selectedTag')"></button>
                                        </span>
                                    }
                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearAllTags()">
                                        <i class="fas fa-times"></i> Clear All
                                    </button>
                                </div>
                            </div>
                            <hr>
                        }

                        <!-- Popular Tags by Category -->
                        @if(Model.PopularTagsByCategory.Any())
                        {
                            @foreach(var categoryGroup in Model.PopularTagsByCategory.Take(4))
                            {
                                <div class="mb-3">
                                    <small class="text-muted d-flex align-items-center">
                                        <i class="@EventsPageViewModel.AvailableCategories.FirstOrDefault(c => c.Value == categoryGroup.Key.ToString())?.IconClass me-1"></i>
                                        @EventsPageViewModel.AvailableCategories.FirstOrDefault(c => c.Value == categoryGroup.Key.ToString())?.DisplayName Tags
                                    </small>
                                    <div class="mt-1">
                                        @foreach(var tag in categoryGroup.Value.Take(8))
                                        {
                                            <button type="button" class="btn btn-sm @tag.BadgeClass me-1 mb-1 tag-button @(Model.SelectedTags.Contains(tag.Name) ? "active" : "")" 
                                                    onclick="toggleTag('@tag.Name')">
                                                @tag.Name <span class="badge bg-light text-dark ms-1">@tag.EventCount</span>
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <!-- All Popular Tags (fallback) -->
                            <div class="tag-cloud">
                                @foreach(var tag in Model.TopTags)
                                {
                                    <button type="button" class="btn btn-sm @tag.BadgeClass me-1 mb-1 tag-button @tag.Size @(Model.SelectedTags.Contains(tag.Name) ? "active" : "")" 
                                            onclick="toggleTag('@tag.Name')">
                                        @tag.Name <span class="badge bg-light text-dark ms-1">@tag.EventCount</span>
                                    </button>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        
        <!-- Active Filters Display -->
        @if(Model.HasActiveFilters)
        {
            <div class="mt-3">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span class="text-muted">Active filters:</span>
                    @if(!string.IsNullOrEmpty(Model.CurrentCategory))
                    {
                        <span class="badge bg-primary">
                            <i class="fas fa-layer-group me-1"></i>Category: @Model.CurrentCategory
                        </span>
                    }
                    @if(!string.IsNullOrEmpty(Model.SelectedSubCategory))
                    {
                        <span class="badge bg-primary">
                            <i class="fas fa-layer-group me-1"></i>SubCategory: @Model.SelectedSubCategory
                        </span>
                    }
                    @if(Model.IsFreeFilter == true)
                    {
                        <span class="badge bg-success">
                            <i class="fas fa-gift me-1"></i>Free Events
                        </span>
                    }
                    @if(Model.IsFreeFilter == false)
                    {
                        <span class="badge bg-warning">
                            <i class="fas fa-dollar-sign me-1"></i>Paid Events
                        </span>
                    }
                    @if(!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        <span class="badge bg-info">
                            <i class="fas fa-search me-1"></i>Search: "@Model.SearchTerm"
                        </span>
                    }
                    @if(Model.SelectedTags.Any())
                    {
                        <span class="badge bg-secondary">
                            <i class="fas fa-tags me-1"></i>Tags: @Model.SelectedTags.Count
                        </span>
                    }
                    <a href="/Events" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-times"></i> Clear All
                    </a>
                </div>
            </div>
        }
    </div>
</section>

<!-- Sorting and View Options -->
<div class="bg-white py-3 border-bottom">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted">Sort by:</span>
                    <div class="btn-group" role="group">
                        @foreach(var sortOption in EventsPageViewModel.AvailableSortOptions)
                        {
                            var isCurrentSort = Model.SortBy == sortOption.Value;
                            var newSortOrder = isCurrentSort && Model.SortOrder == "asc" ? "desc" : "asc";
                            
                            <a href="@Url.Action("Index", "Events", new {
                                    category = Model.CurrentCategory,
                                    free = Model.IsFreeFilter,
                                    search = Model.SearchTerm,
                                    tags = string.Join(",", Model.SelectedTags),
                                    fromDate = Model.FromDate?.ToString("yyyy-MM-dd"),
                                    toDate = Model.ToDate?.ToString("yyyy-MM-dd"),
                                    sortBy = sortOption.Value,
                                    sortOrder = newSortOrder,
                                    page = 1
                            })" 
                               class="btn btn-sm @(isCurrentSort ? "btn-primary" : "btn-outline-secondary")">
                                <i class="@sortOption.IconClass me-1"></i>@sortOption.DisplayName
                                @if(isCurrentSort)
                                {
                                    <i class="fas fa-chevron-@(Model.SortOrder == "asc" ? "up" : "down") ms-1"></i>
                                }
                            </a>
                        }
                    </div>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="d-flex align-items-center justify-content-end gap-2">
                    <span class="text-muted">View:</span>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active" id="grid-view">
                            <i class="fas fa-th"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="list-view">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Section -->
<section class="py-4">
    <div class="container">
        <!-- Results Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>@Model.PageTitle</h2>
                @if(Model.HasActiveFilters)
                {
                    <p class="text-muted mb-0">
                        Filtered results 
                        @if(!string.IsNullOrEmpty(Model.CurrentCategory))
                        {
                            <span class="badge bg-primary">@Model.CurrentCategory</span>
                        }
                        @if(!string.IsNullOrEmpty(Model.SelectedSubCategory))
                        {
                            <span class="badge bg-primary">@Model.SelectedSubCategory</span>
                        }
                        @if(Model.IsFreeFilter == true)
                        {
                            <span class="badge bg-success">Free Events</span>
                        }
                        @if(Model.SelectedTags.Any())
                        {
                            <span class="badge bg-secondary">@Model.SelectedTags.Count Tag@(Model.SelectedTags.Count != 1 ? "s" : "")</span>
                        }
                    </p>
                }
            </div>
            <small class="text-muted">
                Showing @((Model.Events.CurrentPage - 1) * Model.Events.PageSize + 1) - 
                @Math.Min(Model.Events.CurrentPage * Model.Events.PageSize, Model.Events.TotalCount) 
                of @Model.Events.TotalCount events
            </small>
        </div>
        
        <!-- Events Grid -->
        <div class="row">
            @if(Model.Events.Items.Any())
            {
                @foreach(var eventItem in Model.Events.Items)
                {
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card event-card h-100">
                            <a href="@Url.Action("Details", "Events", new { id = eventItem.Id })" class="text-decoration-none">
                                <div class="event-image-container">
                                    <img src="@eventItem.DefaultImage" 
                                         alt="@eventItem.Name" 
                                         class="event-image-full"
                                         onerror="this.src='/images/default_event_image.jpeg'">
                                    @* Show 'Free' badge only for free events *@
                                    @if (eventItem.IsFree)
                                    {
                                    <div class="event-price event-free">Free</div>
                                    }
                                </div>
                            </a>
                            
                            <div class="card-body d-flex flex-column">
                                <h5 class="event-title">
                                    <a href="@Url.Action("Details", "Events", new { id = eventItem.Id })" class="text-decoration-none text-dark">
                                        @eventItem.Name
                                    </a>
                                </h5>
                                <div class="event-date mb-2">
                                    <i class="fas fa-calendar me-1"></i>
                                    @eventItem.FormattedDate @eventItem.FormattedTime
                                </div>
                                <div class="event-venue mb-2">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    @eventItem.Location
                                </div>
                                
                                @if(!string.IsNullOrEmpty(eventItem.CategoryName))
                                {
                                    <div class="mb-2">
                                        <a href="@Url.Action("Category", "Events", new { category = eventItem.CategoryName })" class="badge bg-secondary text-decoration-none">
                                            @eventItem.CategoryName
                                        </a>
                                        @if(!string.IsNullOrEmpty(eventItem.SubCategoryName))
                                        {
                                            <a href="@Url.Action("Index", "Events", new { subCategory = eventItem.SubCategoryName })" 
                                               class="badge bg-dark text-decoration-none ms-1">
                                                @eventItem.SubCategoryName
                                            </a>
                                        }
                                    </div>
                                }
                                
                                <!-- Enhanced Tag Display -->
                                @if(eventItem.Tags.Any())
                                {
                                    <div class="event-tags mb-2">
                                        @foreach(var tag in eventItem.Tags.Take(4))
                                        {
                                            <a href="@Url.Action("ByTag", "Events", new { tagName = tag })" 
                                               class="badge bg-info text-white text-decoration-none me-1 mb-1 tag-link">
                                                <i class="fas fa-tag me-1"></i>@tag
                                            </a>
                                        }
                                        @if(eventItem.Tags.Count > 4)
                                        {
                                            <span class="badge bg-light text-dark">+@(eventItem.Tags.Count - 4) more</span>
                                        }
                                    </div>
                                }
                                
                                @if(!string.IsNullOrEmpty(eventItem.ShortDescription))
                                {
                                    <p class="text-muted small flex-grow-1">@eventItem.ShortDescription</p>
                                }
                            </div>
                            
                            <div class="card-footer bg-transparent">
                                <div class="d-flex justify-content-between">
                                    <a href="@Url.Action("Details", "Events", new { id = eventItem.Id })" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-info-circle me-1"></i>Details
                                    </a>
                                    @if(eventItem.HasTicketUrl)
                                    {
                                        <a href="@eventItem.TicketUrl" target="_blank" class="btn btn-primary btn-sm">
                                            <i class="fas fa-ticket-alt me-1"></i>Buy tickets
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12 text-center py-5">
                    <i class="fas fa-calendar-times text-muted" style="font-size: 4rem;"></i>
                    <h4 class="mt-3 text-muted">No events found</h4>
                    <p class="text-muted">Try adjusting your search criteria or browse all events.</p>
                    <a href="/Events" class="btn btn-primary">View All Events</a>
                </div>
            }
        </div>
        
        <!-- Pagination -->
        @if(Model.Events.TotalPages > 1)
        {
            <nav aria-label="Events pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    @if(Model.Events.HasPreviousPage)
                    {
                        <li class="page-item">
                            <a class="page-link" href="?page=@(Model.Events.CurrentPage - 1)&@Model.FiltersQueryString">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        </li>
                    }
                    
                    @for(var i = Math.Max(1, Model.Events.CurrentPage - 2); i <= Math.Min(Model.Events.TotalPages, Model.Events.CurrentPage + 2); i++)
                    {
                        <li class="page-item @(i == Model.Events.CurrentPage ? "active" : "")">
                            <a class="page-link" href="?page=@i&@Model.FiltersQueryString">@i</a>
                        </li>
                    }
                    
                    @if(Model.Events.HasNextPage)
                    {
                        <li class="page-item">
                            <a class="page-link" href="?page=@(Model.Events.CurrentPage + 1)&@Model.FiltersQueryString">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        }
    </div>
</section>

@section Scripts {
    <!-- jQuery UI for autocomplete -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/ui-lightness/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    
    <!-- Enhanced search and tag functionality -->
    <script>
        // Selected tags array
        let selectedTags = [@Html.Raw(string.Join(",", Model.SelectedTags.Select(t => "\"" + t + "\"")))]
        
        // Tag management functions
        function toggleTag(tagName) {
            if (selectedTags.includes(tagName)) {
                removeTag(tagName);
            } else {
                addTag(tagName);
            }
            $('#search-form').submit();
        }
        
        function addTag(tagName) {
            if (!selectedTags.includes(tagName)) {
                selectedTags.push(tagName);
                updateTagsInput();
                updateTagButtons();
            }
        }
        
        function removeTag(tagName) {
            selectedTags = selectedTags.filter(tag => tag !== tagName);
            updateTagsInput();
            updateTagButtons();
            $('#search-form').submit();
        }
        
        function clearAllTags() {
            selectedTags = [];
            updateTagsInput();
            updateTagButtons();
            $('#search-form').submit();
        }
        
        function updateTagsInput() {
            document.getElementById('tags').value = selectedTags.join(',');
        }
        
        function updateTagButtons() {
            document.querySelectorAll('.tag-button').forEach(button => {
                const tagName = button.textContent.split(' ')[0]; // Get tag name before count
                if (selectedTags.includes(tagName)) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }
        
        // Initialize search functionality when document is ready
        $(document).ready(function() {
            const $searchInput = $('#search');
            if ($searchInput.length) {
                $searchInput.autocomplete({
                    source: function(request, response) {
                        $.ajax({
                            url: '/Events/Search',
                            data: { query: request.term },
                            success: function(data) {
                                response($.map(data, function(item) {
                                    if (item.isTag) {
                                        return {
                                            label: item.name + ' (' + item.location + ')',
                                            value: item.name,
                                            isTag: true,
                                            tagName: item.tagName
                                        };
                                    } else {
                                        return {
                                            label: item.name + (item.category ? ' (' + item.category + ')' : ''),
                                            value: item.name,
                                            id: item.id,
                                            category: item.category,
                                            isTag: false
                                        };
                                    }
                                }));
                            }
                        });
                    },
                    minLength: 2,
                    select: function(event, ui) {
                        if (ui.item.isTag) {
                            addTag(ui.item.tagName);
                            $searchInput.val('');
                            $('#search-form').submit();
                        } else {
                            window.location.href = '/Events/Details/' + ui.item.id;
                        }
                        return false;
                    },
                    focus: function(event, ui) {
                        $searchInput.val(ui.item.value);
                        return false;
                    }
                }).autocomplete('instance')._renderItem = function(ul, item) {
                    const iconClass = item.isTag ? 'fas fa-tag text-info' : 'fas fa-calendar text-primary';
                    return $('<li>')
                        .append("<div class='autocomplete-item'><i class='" + iconClass + " me-2'></i><strong>" + item.label + "</strong></div>")
                        .appendTo(ul);
                };
            }
            
            // AJAX handler for category change - populate subcategories dynamically
            $('#category').change(function() {
                const selectedCategory = $(this).val();
                const $subCategorySelect = $('#subCategory');
                
                if (!selectedCategory) {
                    $subCategorySelect.html('<option value="" selected>Select a category first</option>');
                    return;
                }
                
                $.ajax({
                    url: '/api/categories/subcategories',
                    data: { category: selectedCategory },
                    success: function(data) {
                        let html = '<option value="" selected>All Subcategories</option>';
                        
                        if (data && data.length > 0) {
                            $.each(data, function(index, item) {
                                html += '<option value="' + item.id + '">' + item.name + '</option>';
                            });
                        } else {
                            html = '<option value="" selected>No subcategories available</option>';
                        }
                        
                        $subCategorySelect.html(html);
                    },
                    error: function(err) {
                        console.error('Error loading subcategories:', err);
                        $subCategorySelect.html('<option value="" selected>Error loading subcategories</option>');
                    }
                });
                
                // Auto-submit form when category changes
                $('#search-form').submit();
            });
            
            // Auto-submit form when major filters change (instant feedback for better UX)
            $('#subCategory, #free, #fromDate, #toDate').change(function() {
                $('#search-form').submit();
            });
        });
    </script>
    
    <!-- Custom CSS for tag functionality -->
    <style>
        .tag-button.active {
            opacity: 0.8;
            box-shadow: 0 0 0 2px rgba(var(--bs-primary-rgb), 0.25);
        }
        
        .tag-link:hover {
            transform: translateY(-1px);
            transition: transform 0.2s;
        }
        
        .event-tags .badge {
            transition: all 0.2s;
        }
        
        .event-tags .badge:hover {
            transform: scale(1.05);
        }
        
        .autocomplete-item {
            padding: 8px;
        }
        
        .tag-cloud .btn {
            margin-right: 4px;
            margin-bottom: 4px;
        }
    </style>
}